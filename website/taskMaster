from celery_config import celery
from . import create_app
from . import db_clinical

ITEMS_COLLECTION = db_clinical['items']
items = ITEMS_COLLECTION.find()

@celery.task
def watch_inventory_changes(name, email):
    app=create_app()
    with app.app_context():
        try:
            with ITEMS_COLLECTION.watch(full_document='updateLookup') as stream:
                print("watching")
                subject = "Stock Alert"
                for change in stream:
                    if (
                        change['operationType'] == 'update' and
                        change['updateDescription']['updatedFields']['in stock'] <=
                        change['updateDescription']['updatedFields'].get('reOrderLevel', float('inf'))
                    ):
                        html= f'<h5>Hello {name},<br></h5><p>Your stock alert level: <br>{change["fullDocument"]["item"]} has {change["fullDocument"]["in stock"]} vials in and is at or below the reorder stock level</p>'
                        # mailer(email,subject,html)
        except Exception as e:
            print(f"An error occurred: {e}")

def stockAlert(email, name):
    alert_items = []
    for item in items:
        if 4 < item['in stock'] < 5:
            item_name = item['item']
            quantity = item['in stock']
            test = f'{item_name} has {quantity} vials in stock'
            alert_items.append(test)
        # print(alert_items)
    subject="Stock Alert"
     
    html = f'<h5>Hello {name},<br></h5><p>Your stock alert level: <br>{ "<br>".join(alert_items) }</p>'
    # mail.send(message)
    # mailer(email, subject, html)